<div class="story-planner p-4 h-full flex flex-col">
  <h2 class="text-2xl font-bold mb-4 text-yellow-400">AI Story Planner</h2>
  <p class="text-gray-400 mb-4">
    Generate a coherent story plan with actionable elements based on your campaign's history and world structure.
  </p>

  <div class="mb-4">
    <label class="block text-sm font-medium text-gray-400 mb-1">Additional Context / Instructions</label>
    <textarea
      class="w-full h-32 bg-gray-800 text-white p-3 rounded border border-gray-700 focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500"
      [value]="storyContext()" (input)="onStoryContextChange($event)"
      placeholder="e.g., The party is heading to the frozen north. Focus on ice-themed encounters..."></textarea>
  </div>

  <button (click)="getSuggestions()" [disabled]="isLoading()"
    class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors w-full md:w-auto self-start mb-6">
    {{ isLoading() ? 'Generating Plan...' : 'Generate Plan' }}
  </button>

  @if (error()) {
  <div class="bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg mb-6">
    <p>{{ error() }}</p>
  </div>
  }

  @if (suggestions().length > 0) {
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto pb-20">
    @for(suggestion of suggestions(); track $index) {
    <div
      class="bg-gray-800 border border-gray-700 rounded-lg p-4 flex flex-col shadow-lg hover:border-gray-600 transition-colors">
      <div class="flex justify-between items-start mb-2">
        <span class="text-xs font-bold px-2 py-1 rounded uppercase tracking-wider" [ngClass]="{
                'bg-purple-900 text-purple-300': suggestion.type === 'NPC',
                'bg-green-900 text-green-300': suggestion.type === 'Quest',
                'bg-blue-900 text-blue-300': suggestion.type === 'Location',
                'bg-red-900 text-red-300': suggestion.type === 'Event',
                'bg-yellow-900 text-yellow-300': suggestion.type === 'Hook'
              }">
          {{ suggestion.type }}
        </span>
      </div>

      <input type="text" [(ngModel)]="suggestion.name"
        class="text-lg font-bold text-white bg-transparent border-b border-transparent hover:border-gray-600 focus:border-yellow-500 focus:outline-none mb-2 w-full" />

      <textarea [(ngModel)]="suggestion.description"
        class="text-sm text-gray-300 bg-gray-900/50 rounded p-2 mb-4 flex-grow resize-none focus:ring-1 focus:ring-yellow-500 focus:outline-none min-h-[100px]"></textarea>

      @if (suggestion.type === 'NPC') {
      <div class="mb-2">
        <label class="block text-xs font-medium text-gray-500 mb-1">Generator Context</label>
        <textarea [(ngModel)]="suggestion.data.context" placeholder="Context for NPC generator..."
          class="w-full text-xs text-gray-400 bg-gray-900/30 rounded p-2 resize-none focus:ring-1 focus:ring-purple-500 focus:outline-none h-16 mb-2"></textarea>

        <div class="flex justify-end mb-2">
          <button (click)="previewStats(suggestion)" [disabled]="generatingStatsForItem() === suggestion.name"
            class="text-xs bg-purple-700 hover:bg-purple-600 text-white font-bold py-1 px-2 rounded disabled:opacity-50 transition-colors">
            {{ generatingStatsForItem() === suggestion.name ? 'Generating Stats...' : 'Preview Stats' }}
          </button>
        </div>

        @if (suggestion.previewStats) {
        <div class="bg-black/30 p-2 rounded text-xs mb-2 border border-gray-700">
          <div class="flex justify-between mb-1">
            <span class="text-gray-300 font-bold">{{ suggestion.previewStats.race }} {{ suggestion.previewStats.class }}
              {{ suggestion.previewStats.level }}</span>
            <span class="text-gray-400">{{ suggestion.previewStats.alignment }}</span>
          </div>
          @if (suggestion.previewStats.baseStats) {
          <div class="grid grid-cols-6 gap-1 text-center">
            @for(stat of ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha']; track stat) {
            <div class="bg-gray-800 p-1 rounded">
              <span class="block text-[10px] text-gray-500 uppercase">{{stat}}</span>
              <span class="block font-bold text-white">{{suggestion.previewStats.baseStats[stat]}}</span>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
      }

      <div class="mt-auto pt-4 border-t border-gray-700 flex justify-between items-center">
        <div class="text-xs text-gray-500">
          Path: <input type="text" [(ngModel)]="suggestion.path"
            class="bg-transparent border-b border-gray-700 text-gray-400 w-24 focus:border-yellow-500 focus:outline-none">
        </div>
        <button (click)="saveSuggestion(suggestion)" [disabled]="savingItem() === suggestion.name"
          class="bg-green-700 hover:bg-green-600 text-white text-sm font-bold py-1 px-3 rounded disabled:opacity-50 transition-colors">
          {{ savingItem() === suggestion.name ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>
    }
  </div>
  }
</div>
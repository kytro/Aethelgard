<div class="p-4 bg-gray-900 text-gray-100 min-h-screen">
    <h2 class="text-2xl font-bold mb-4 text-white">Google Docs Import (Tree Mode)</h2>

    <!-- STEP 1: Connect -->
    <div *ngIf="step() === 1" class="step-container">
        <h3 class="text-xl mb-2 text-blue-400">Step 1: Connect Document</h3>
        <p class="text-sm text-gray-400 mb-2">Note: The document must be publicly accessible.</p>
        <div class="flex gap-2">
            <input type="text" [ngModel]="docIdInput()" (ngModelChange)="docIdInput.set($event)"
                placeholder="Paste Google Doc Link here..."
                class="border border-gray-600 bg-gray-800 p-2 rounded flex-1 text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none">
            <button (click)="fetchDoc()"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
                [disabled]="isLoading()">
                {{ isLoading() ? 'Fetching...' : 'Fetch' }}
            </button>
        </div>
    </div>

    <!-- STEP 2: Configure Tree -->
    <div *ngIf="step() === 2" class="step-container">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl text-blue-400">Step 2: Review & Import Hierarchy</h3>
            <div class="flex gap-2">
                <button (click)="reset()"
                    class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">Back</button>
                <button (click)="saveImport()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Import Selected
                </button>
            </div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded p-4 overflow-x-auto">
            <!-- Recursive Tree Template -->
            <ng-template #nodeTemplate let-nodes="nodes">
                <div *ngFor="let node of nodes" class="mb-1">
                    <div class="flex items-center gap-2 py-1 hover:bg-gray-700 rounded px-1 transition-colors">

                        <!-- Expand/Collapse -->
                        <button (click)="toggleNode(node)"
                            class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white">
                            <span *ngIf="node.children.length > 0">
                                {{ node.expanded ? '▼' : '▶' }}
                            </span>
                        </button>

                        <!-- Import Checkbox -->
                        <input type="checkbox" [checked]="node.isPage" (change)="toggleIsPage(node)"
                            class="w-4 h-4 rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700">

                        <!-- Node Path/Name Input -->
                        <!-- If importing as page, show Path Input. Else just show text (as content). -->
                        <div class="relative flex-1 mx-2" *ngIf="node.isPage">
                            <input type="text" [value]="node.pathString" (input)="handlePathInput(node, $event)"
                                (focus)="onFocusPath(node)" (blur)="activeNodeId.set(null)"
                                class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-sm text-green-300 focus:border-yellow-500 focus:outline-none">

                            <!-- Autosuggest Dropdown -->
                            <div *ngIf="activeNodeId() === node.id && filteredPaths().length > 0" class="dropdown-list">
                                <div *ngFor="let path of filteredPaths()" (mousedown)="selectPathSuggestion(node, path)"
                                    class="dropdown-item text-sm">
                                    {{ path }}
                                </div>
                            </div>
                        </div>

                        <span *ngIf="!node.isPage" class="flex-1 text-gray-500 italic text-sm">
                            {{ node.text }} (Merged into parent)
                        </span>

                        <!-- Manual Indicator -->
                        <span *ngIf="node.isManual" class="text-xs text-yellow-500 mx-2" title="Manually edited path">
                            [M]
                        </span>

                        <!-- Level Badge -->
                        <span class="text-xs text-gray-600 px-1 border border-gray-700 rounded">
                            H{{ node.level }}
                        </span>
                    </div>

                    <!-- Children recursively -->
                    <div *ngIf="node.expanded && node.children.length > 0" class="tree-node">
                        <ng-container
                            *ngTemplateOutlet="nodeTemplate; context: { nodes: node.children }"></ng-container>
                    </div>
                </div>
            </ng-template>

            <!-- Start Tree -->
            <ng-container *ngTemplateOutlet="nodeTemplate; context: { nodes: rootNodes() }"></ng-container>
        </div>
    </div>
</div>